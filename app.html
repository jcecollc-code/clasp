<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clasp App</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--blue:#0A66C2;--blue-dark:#004182;--blue-deep:#001B3D;--blue-light:#EAF3FF;--teal:#00B4A6;--teal-light:rgba(0,180,166,0.1);--green:#10B981;--green-light:rgba(16,185,129,0.1);--red:#EF4444;--bg:#F5F7FA;--text:#1A2332;--muted:#637B96;--light:#94A3B8;--border:#E4EBF4;--shadow:0 4px 16px rgba(0,30,80,0.08);--shadow-lg:0 16px 48px rgba(0,30,80,0.14);--radius:12px;--sidebar-w:232px;}
*{margin:0;padding:0;box-sizing:border-box;}html,body{height:100%;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);font-size:14px;-webkit-font-smoothing:antialiased;overflow:hidden;}

/* AUTH */
.auth-screen{display:none;position:fixed;inset:0;z-index:2000;background:linear-gradient(135deg,var(--blue-deep),var(--blue-dark),#00243F);align-items:center;justify-content:center;}
.auth-screen.visible{display:flex;}
.auth-box{background:white;border-radius:20px;padding:48px 40px;width:420px;text-align:center;box-shadow:var(--shadow-lg);animation:fadeUp 0.4s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.auth-logo{font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:800;color:var(--blue-dark);display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px;cursor:pointer;}
.auth-logo-mark{width:36px;height:36px;border-radius:10px;background:var(--blue);display:flex;align-items:center;justify-content:center;}
.auth-logo-mark svg{width:18px;height:18px;}
.auth-tagline{font-size:0.9rem;color:var(--muted);margin-bottom:32px;}
.auth-tabs{display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:24px;}
.auth-tab{flex:1;padding:10px;font-size:0.85rem;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;transition:all 0.15s;}
.auth-tab.active{background:var(--blue);color:white;}
.auth-form{display:flex;flex-direction:column;gap:10px;}
.auth-input{border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;font-family:'Outfit',sans-serif;font-size:0.9rem;color:var(--text);outline:none;transition:border-color 0.2s;width:100%;}
.auth-input:focus{border-color:var(--blue);}
.auth-btn{background:var(--blue);color:white;border:none;border-radius:10px;padding:13px;font-family:'Outfit',sans-serif;font-size:0.92rem;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:4px;}
.auth-btn:hover{background:var(--blue-dark);}
.auth-btn:disabled{opacity:0.6;cursor:not-allowed;}
.auth-divider{display:flex;align-items:center;gap:12px;margin:4px 0;color:var(--light);font-size:0.78rem;}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.google-btn{display:flex;align-items:center;justify-content:center;gap:10px;background:white;border:1.5px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;font-family:'Outfit',sans-serif;font-size:0.88rem;font-weight:500;color:var(--text);transition:all 0.2s;width:100%;}
.google-btn:hover{border-color:var(--blue);background:var(--blue-light);}
.auth-error{color:var(--red);font-size:0.78rem;padding:8px 12px;background:rgba(239,68,68,0.08);border-radius:8px;display:none;text-align:left;margin-bottom:4px;}
.auth-success{color:var(--green);font-size:0.78rem;padding:8px 12px;background:var(--green-light);border-radius:8px;display:none;text-align:left;margin-bottom:4px;}

/* LAYOUT */
.app{display:flex;height:100vh;}
.sidebar{width:var(--sidebar-w);background:white;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.sidebar-top{padding:20px 16px 16px;border-bottom:1px solid var(--border);}
.logo{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;color:var(--blue-dark);display:flex;align-items:center;gap:8px;margin-bottom:20px;cursor:pointer;}
.logo-mark{width:30px;height:30px;border-radius:8px;background:var(--blue);display:flex;align-items:center;justify-content:center;}
.logo-mark svg{width:16px;height:16px;}
.agent-trigger{width:100%;background:var(--blue-deep);border:none;border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px;cursor:pointer;font-family:'Outfit',sans-serif;transition:background 0.2s;}
.agent-trigger:hover{background:#0A2240;}
.agent-orb{width:20px;height:20px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;}
.agent-orb svg{width:10px;height:10px;}
.agent-trigger-text{flex:1;text-align:left;}
.agent-trigger-text span:first-child{display:block;color:rgba(255,255,255,0.5);font-size:0.68rem;letter-spacing:0.5px;}
.agent-trigger-text span:last-child{display:block;color:rgba(255,255,255,0.85);font-size:0.78rem;}
.kbd{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.4);font-size:0.65rem;padding:2px 6px;border-radius:4px;}
.sidebar-nav{flex:1;padding:12px 8px;overflow-y:auto;}
.nav-label{font-size:0.65rem;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--light);padding:8px 8px 4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;color:var(--muted);cursor:pointer;transition:all 0.15s;font-size:0.88rem;font-weight:500;}
.nav-item:hover{background:var(--blue-light);color:var(--blue);}
.nav-item.active{background:var(--blue-light);color:var(--blue);font-weight:600;}
.nav-item svg{width:16px;height:16px;flex-shrink:0;}
.sidebar-user{padding:14px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.user-av{width:34px;height:34px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.78rem;cursor:pointer;}
.user-name{font-size:0.82rem;font-weight:600;}
.user-role{font-size:0.72rem;color:var(--muted);margin-top:1px;}
.signout-btn{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--light);padding:4px;font-size:0.7rem;font-family:'Outfit',sans-serif;}
.signout-btn:hover{color:var(--red);}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.topbar{height:52px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;flex-shrink:0;}
.page-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--blue-deep);}
.screen{display:none;flex:1;overflow-y:auto;padding:24px;}
.screen.active{display:block;}
#screen-messages.active,#screen-channels.active{display:flex!important;padding:0;}
#screen-messages.active .msg-screen-layout,#screen-channels.active .channel-layout{height:calc(100vh - 104px);}
.screen.active.flex-screen{display:flex!important;}
.agent-screen{display:none;flex:1;flex-direction:column;overflow:hidden;}
.agent-screen.active{display:flex!important;}

/* AGENT */
.agent-header-bar{padding:16px 24px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;}
.agent-status{display:flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--teal);font-weight:500;}
.agent-status-dot{width:7px;height:7px;border-radius:50%;background:var(--teal);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.3)}}
.chat-area{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px;}
.msg{display:flex;gap:10px;max-width:80%;}
.msg.user{align-self:flex-end;flex-direction:row-reverse;}
.msg-av{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.72rem;margin-top:2px;}
.msg-av.agent-av{background:linear-gradient(135deg,var(--blue),var(--teal));}
.msg-av.user-av{background:linear-gradient(135deg,var(--blue-dark),var(--blue));}
.msg-bubble{border-radius:14px;padding:12px 16px;font-size:0.85rem;line-height:1.65;}
.msg.agent .msg-bubble{background:white;border:1px solid var(--border);border-bottom-left-radius:4px;color:var(--text);}
.msg.user .msg-bubble{background:var(--blue);color:white;border-bottom-right-radius:4px;}
.msg-time{font-size:0.68rem;color:var(--light);margin-top:5px;}
.msg.user .msg-time{text-align:right;}
.typing-indicator{display:flex;gap:4px;align-items:center;padding:14px 16px;}
.typing-dot{width:7px;height:7px;border-radius:50%;background:var(--muted);animation:typing 1.2s infinite;}
.typing-dot:nth-child(2){animation-delay:0.2s;}
.typing-dot:nth-child(3){animation-delay:0.4s;}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:0.4}30%{transform:translateY(-6px);opacity:1}}
.suggestion-chips{display:flex;gap:8px;flex-wrap:wrap;padding:0 24px 16px;}
.chip{background:white;border:1px solid var(--border);border-radius:20px;padding:7px 16px;font-size:0.78rem;font-weight:500;color:var(--muted);cursor:pointer;transition:all 0.15s;font-family:'Outfit',sans-serif;}
.chip:hover{background:var(--blue-light);border-color:var(--blue);color:var(--blue);}
.compose-bar{padding:16px 24px;background:white;border-top:1px solid var(--border);flex-shrink:0;}
.compose-inner{display:flex;align-items:flex-end;gap:10px;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:10px 14px;transition:border-color 0.2s;}
.compose-inner:focus-within{border-color:var(--blue);}
.compose-textarea{flex:1;border:none;outline:none;background:transparent;resize:none;font-family:'Outfit',sans-serif;font-size:0.9rem;color:var(--text);min-height:24px;max-height:120px;}
.compose-textarea::placeholder{color:var(--light);}
.send-btn{background:var(--blue);border:none;border-radius:8px;width:34px;height:34px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.send-btn:hover{background:var(--blue-dark);}
.send-btn:disabled{background:var(--border);cursor:not-allowed;}
.send-btn svg{width:15px;height:15px;}

/* FORMS */
.edit-form{display:flex;flex-direction:column;gap:12px;}
.form-row{display:flex;gap:10px;}
.form-group{display:flex;flex-direction:column;gap:5px;flex:1;}
.form-label{font-size:0.75rem;font-weight:600;color:var(--muted);}
.form-input{border:1.5px solid var(--border);border-radius:8px;padding:9px 12px;font-family:'Outfit',sans-serif;font-size:0.88rem;color:var(--text);outline:none;transition:border-color 0.2s;background:white;}
.form-input:focus{border-color:var(--blue);}
.form-textarea{min-height:80px;resize:vertical;}
.btn-save{background:var(--blue);color:white;border:none;border-radius:8px;padding:10px 24px;font-family:'Outfit',sans-serif;font-size:0.88rem;font-weight:600;cursor:pointer;align-self:flex-start;}
.btn-save:hover{background:var(--blue-dark);}
.btn-sm{border:none;border-radius:8px;padding:7px 14px;font-size:0.76rem;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;transition:all 0.15s;white-space:nowrap;}
.btn-blue{background:var(--blue);color:white;}
.btn-blue:hover{background:var(--blue-dark);}
.btn-dark{background:var(--blue-deep);color:rgba(255,255,255,0.85);display:flex;align-items:center;gap:4px;}
.btn-dark:hover{background:#0A2240;}
.btn-ghost{background:var(--bg);color:var(--muted);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--blue-light);color:var(--blue);border-color:var(--blue);}

/* PROFILE */
.profile-layout{display:grid;grid-template-columns:1fr 280px;gap:20px;max-width:1100px;}
.white-card{background:white;border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;margin-bottom:16px;}
.profile-cover{height:100px;background:linear-gradient(135deg,var(--blue-dark),var(--blue),var(--teal));}
.profile-identity{padding:0 24px 20px;}
.profile-av-wrap{margin-top:-32px;margin-bottom:10px;display:inline-block;}
.profile-av{width:64px;height:64px;border-radius:50%;border:3px solid white;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:1.2rem;}
.profile-name{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;color:var(--blue-deep);}
.profile-headline{font-size:0.88rem;color:var(--muted);margin-top:3px;}
.profile-meta{display:flex;gap:16px;margin-top:8px;flex-wrap:wrap;}
.profile-meta-item{font-size:0.78rem;color:var(--muted);display:flex;align-items:center;gap:4px;}
.profile-stats{display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin:14px 0;}
.stat-box{flex:1;padding:10px;text-align:center;border-right:1px solid var(--border);}
.stat-box:last-child{border-right:none;}
.stat-num{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--blue-dark);}
.stat-label{font-size:0.65rem;color:var(--muted);margin-top:2px;}
.profile-section{padding:16px 24px;border-top:1px solid var(--border);}
.section-heading{font-family:'Syne',sans-serif;font-size:0.88rem;font-weight:700;color:var(--blue-deep);margin-bottom:12px;}
.skills-wrap{display:flex;flex-wrap:wrap;gap:6px;}
.skill-tag{background:var(--blue-light);color:var(--blue);font-size:0.75rem;font-weight:500;padding:4px 12px;border-radius:20px;}
.skill-tag.removable{cursor:pointer;}
.skill-tag.removable:hover{background:#fee;color:var(--red);}
.open-to-wrap{display:flex;flex-wrap:wrap;gap:6px;}
.open-tag{background:var(--green-light);color:var(--green);font-size:0.75rem;font-weight:500;padding:4px 12px;border-radius:20px;}
.exp-item{padding:12px 0;border-bottom:1px solid var(--border);}
.exp-item:last-child{border-bottom:none;}
.exp-title{font-size:0.88rem;font-weight:600;color:var(--text);}
.exp-company{font-size:0.8rem;color:var(--muted);}
.exp-dates{font-size:0.72rem;color:var(--light);margin-top:2px;}
.side-card{background:white;border-radius:var(--radius);border:1px solid var(--border);padding:16px;margin-bottom:14px;}
.side-title{font-family:'Syne',sans-serif;font-size:0.82rem;font-weight:700;color:var(--blue-deep);margin-bottom:10px;}

/* PEOPLE DIRECTORY */
.search-bar-wrap{display:flex;align-items:center;gap:8px;background:white;border:1.5px solid var(--border);border-radius:10px;padding:10px 16px;margin-bottom:16px;}
.search-bar-wrap:focus-within{border-color:var(--blue);}
.search-bar-wrap svg{width:16px;height:16px;color:var(--muted);flex-shrink:0;}
.search-input{border:none;outline:none;flex:1;font-family:'Outfit',sans-serif;font-size:0.9rem;color:var(--text);}
.search-input::placeholder{color:var(--light);}
.person-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;margin-bottom:10px;display:flex;gap:14px;transition:all 0.15s;cursor:pointer;}
.person-card:hover{border-color:var(--blue);box-shadow:var(--shadow);}
.person-av{width:48px;height:48px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:1rem;}
.person-name{font-size:0.92rem;font-weight:600;}
.person-role{font-size:0.78rem;color:var(--muted);margin-top:2px;}
.person-tags{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;}
.ptag{font-size:0.68rem;font-weight:500;padding:2px 8px;border-radius:8px;background:var(--blue-light);color:var(--blue);}
.otag{font-size:0.68rem;font-weight:500;padding:2px 8px;border-radius:8px;background:var(--green-light);color:var(--green);}
.person-actions{display:flex;flex-direction:column;gap:6px;align-items:flex-end;justify-content:center;margin-left:auto;}

/* PUBLIC PROFILE MODAL */
.profile-modal{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,20,50,0.5);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding:40px 20px;overflow-y:auto;}
.profile-modal.open{display:flex;}
.profile-modal-box{background:var(--bg);border-radius:16px;width:100%;max-width:800px;overflow:hidden;box-shadow:var(--shadow-lg);animation:fadeUp 0.2s ease;}
.modal-close{position:absolute;top:16px;right:16px;background:white;border:1px solid var(--border);border-radius:8px;padding:6px 12px;cursor:pointer;font-size:0.8rem;font-family:'Outfit',sans-serif;color:var(--muted);}
.modal-close:hover{color:var(--text);}

/* DRAFTS */
.draft-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;margin-bottom:10px;}
.draft-meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.draft-to{font-size:0.85rem;font-weight:600;}
.draft-type{font-size:0.7rem;background:var(--blue-light);color:var(--blue);padding:2px 8px;border-radius:8px;font-weight:500;}
.draft-content{font-size:0.82rem;color:var(--muted);line-height:1.6;white-space:pre-wrap;}
.draft-time{font-size:0.7rem;color:var(--light);margin-top:8px;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;z-index:999;background:var(--blue-deep);color:white;padding:12px 20px;border-radius:10px;font-size:0.85rem;font-weight:500;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:8px;transform:translateY(80px);opacity:0;transition:all 0.3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}

/* SPOTLIGHT */
.spotlight-overlay{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,20,50,0.5);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:12vh;}
.spotlight-overlay.open{display:flex;}
.spotlight-box{width:600px;background:white;border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;animation:spotOpen 0.18s ease;}
@keyframes spotOpen{from{opacity:0;transform:scale(0.96) translateY(-10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.spot-input-row{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--border);}
.spot-orb{width:26px;height:26px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;}
.spot-orb svg{width:12px;height:12px;}
.spot-input{flex:1;border:none;outline:none;font-family:'Outfit',sans-serif;font-size:1rem;color:var(--text);}
.spot-input::placeholder{color:var(--light);}
.spot-esc{font-size:0.68rem;background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:2px 7px;color:var(--muted);}
.spot-suggestions{padding:8px;}
.spot-label{font-size:0.65rem;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--light);padding:6px 10px 4px;}
.spot-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;cursor:pointer;transition:background 0.1s;}
.spot-item:hover{background:var(--blue-light);}
.spot-icon{width:28px;height:28px;border-radius:7px;background:var(--bg);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.spot-icon svg{width:14px;height:14px;color:var(--blue);}
.spot-title{font-size:0.83rem;font-weight:500;color:var(--text);}
.spot-sub{font-size:0.72rem;color:var(--muted);margin-top:1px;}
.spot-footer{padding:8px 18px;border-top:1px solid var(--border);display:flex;gap:12px;background:var(--bg);}
.spot-hint{font-size:0.68rem;color:var(--light);display:flex;align-items:center;gap:4px;}
.spot-hint kbd{background:white;border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-family:'Outfit',sans-serif;font-size:0.65rem;}

/* MESSAGING */
.msg-screen-layout{display:flex;overflow:hidden;height:calc(100vh - 104px);width:100%;border:1px solid var(--border);border-radius:var(--radius);background:white;}
.conv-list{width:260px;border-right:1px solid var(--border);background:white;display:flex;flex-direction:column;flex-shrink:0;}
.conv-list-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.conv-list-title{font-family:'Syne',sans-serif;font-size:0.88rem;font-weight:700;color:var(--blue-deep);}
.conv-search{padding:10px 12px;border-bottom:1px solid var(--border);}
.conv-search input{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:7px 10px;font-family:'Outfit',sans-serif;font-size:0.82rem;outline:none;}
.conv-search input:focus{border-color:var(--blue);}
.conv-items{flex:1;overflow-y:auto;}
.conv-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.1s;display:flex;gap:10px;align-items:center;}
.conv-item:hover{background:var(--blue-light);}
.conv-item.active{background:var(--blue-light);}
.conv-av{width:36px;height:36px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.72rem;}
.conv-name{font-size:0.85rem;font-weight:600;color:var(--text);}
.conv-preview{font-size:0.75rem;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px;}
.conv-time{font-size:0.68rem;color:var(--light);margin-left:auto;flex-shrink:0;}
.conv-unread{width:8px;height:8px;border-radius:50%;background:var(--blue);flex-shrink:0;}
.dm-window{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.dm-header{padding:14px 20px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;}
.dm-header-av{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.75rem;}
.dm-header-name{font-size:0.9rem;font-weight:600;color:var(--text);}
.dm-header-role{font-size:0.75rem;color:var(--muted);}
.dm-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;}
.dm-msg{display:flex;gap:8px;max-width:75%;}
.dm-msg.mine{align-self:flex-end;flex-direction:row-reverse;}
.dm-msg-av{width:28px;height:28px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.65rem;margin-top:2px;}
.dm-bubble{background:white;border:1px solid var(--border);border-radius:12px;border-bottom-left-radius:3px;padding:10px 14px;font-size:0.85rem;line-height:1.6;color:var(--text);}
.dm-msg.mine .dm-bubble{background:var(--blue);color:white;border:none;border-bottom-right-radius:3px;border-bottom-left-radius:12px;}
.dm-time{font-size:0.65rem;color:var(--light);margin-top:4px;}
.dm-msg.mine .dm-time{text-align:right;}
.dm-compose{padding:14px 20px;background:white;border-top:1px solid var(--border);flex-shrink:0;}
.dm-compose-inner{display:flex;align-items:flex-end;gap:8px;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:8px 12px;}
.dm-compose-inner:focus-within{border-color:var(--blue);}
.dm-textarea{flex:1;border:none;outline:none;background:transparent;resize:none;font-family:'Outfit',sans-serif;font-size:0.88rem;color:var(--text);min-height:22px;max-height:100px;}
.dm-textarea::placeholder{color:var(--light);}

/* Claude suggestion bar */
.claude-suggestion{background:var(--blue-deep);border-radius:10px;padding:10px 14px;margin:0 20px 10px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:background 0.15s;}
.claude-suggestion:hover{background:#0A2240;}
.claude-suggestion-text{flex:1;font-size:0.78rem;color:rgba(255,255,255,0.85);line-height:1.5;}
.claude-suggestion-label{font-size:0.65rem;color:rgba(255,255,255,0.4);margin-bottom:2px;}
.approve-btn{background:var(--teal);color:white;border:none;border-radius:6px;padding:5px 12px;font-size:0.75rem;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap;}
.approve-btn:hover{background:#009e92;}
.dismiss-btn{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.5);border:none;border-radius:6px;padding:5px 8px;font-size:0.75rem;cursor:pointer;font-family:'Outfit',sans-serif;}

/* CHANNELS */
.channel-layout{display:flex;overflow:hidden;height:calc(100vh - 104px);width:100%;border:1px solid var(--border);border-radius:var(--radius);background:white;}
.channel-list{width:220px;border-right:1px solid var(--border);background:white;display:flex;flex-direction:column;flex-shrink:0;}
.channel-list-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.channel-items{flex:1;overflow-y:auto;padding:8px;}
.channel-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:0.85rem;color:var(--muted);transition:all 0.1s;}
.channel-item:hover{background:var(--blue-light);color:var(--blue);}
.channel-item.active{background:var(--blue-light);color:var(--blue);font-weight:600;}
.channel-hash{font-size:1rem;color:var(--light);}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px;color:var(--muted);}
.empty-state-icon{font-size:2.5rem;margin-bottom:12px;}
.empty-state-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--blue-deep);margin-bottom:6px;}
.empty-state-sub{font-size:0.82rem;line-height:1.6;}
</style>
</head>
<body>

<!-- AUTH -->
<div class="auth-screen visible" id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo" onclick="window.location.href='/'">
      <div class="auth-logo-mark"><svg viewBox="0 0 16 16" fill="none"><path d="M3 8h10M8 3l5 5-5 5" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
      Clasp
    </div>
    <div class="auth-tagline">Professional networking for the agent era</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-signin" onclick="switchTab('signin')">Sign In</button>
      <button class="auth-tab" id="tab-signup" onclick="switchTab('signup')">Sign Up</button>
    </div>
    <div class="auth-error" id="auth-error"></div>
    <div class="auth-success" id="auth-success"></div>
    <div class="auth-form">
      <input class="auth-input" type="email" id="auth-email" placeholder="Work email" autocomplete="email">
      <input class="auth-input" type="password" id="auth-password" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')authSubmit()">
      <input class="auth-input" type="text" id="auth-name" placeholder="Your full name" style="display:none" autocomplete="name">
      <button class="auth-btn" id="auth-submit-btn" onclick="authSubmit()">Sign In</button>
    </div>
    <div class="auth-divider">or</div>
    <button class="google-btn" onclick="signInWithGoogle()">
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none">
  <aside class="sidebar">
    <div class="sidebar-top">
      <div class="logo" onclick="window.location.href='/'"><div class="logo-mark"><svg viewBox="0 0 16 16" fill="none"><path d="M3 8h10M8 3l5 5-5 5" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></div>Clasp</div>
      <button class="agent-trigger" onclick="openSpotlight()">
        <div class="agent-orb"><svg viewBox="0 0 24 24" fill="white"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg></div>
        <div class="agent-trigger-text"><span>Ask Claude</span><span>Your AI networking agent</span></div>
        <span class="kbd">âŒ˜K</span>
      </button>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-label">Workspace</div>
      <div class="nav-item active" onclick="switchScreen('agent',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg>Claude Agent</div>
      <div class="nav-item" onclick="switchScreen('profile',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M6 20v-1a6 6 0 0 1 12 0v1"/></svg>My Profile</div>
      <div class="nav-item" onclick="switchScreen('people',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>People</div>
      <div class="nav-item" onclick="switchScreen('outreach',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Draft Outreach</div>
      <div class="nav-item" onclick="switchScreen('drafts',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Saved Drafts</div>
      <div class="nav-label" style="margin-top:8px;">Connect</div>
      <div class="nav-item" id="nav-messages" onclick="switchScreen('messages',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Messages<span id="msg-badge" style="display:none;background:var(--red);color:white;font-size:0.6rem;padding:1px 6px;border-radius:10px;margin-left:auto;">0</span></div>
      <div class="nav-item" id="nav-channels" onclick="switchScreen('channels',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Team Channels</div>
    </nav>
    <div class="sidebar-user">
      <div class="user-av" id="sidebar-av" onclick="switchScreen('profile',document.querySelectorAll('.nav-item')[1])">?</div>
      <div><div class="user-name" id="sidebar-name">Loadingâ€¦</div><div class="user-role" id="sidebar-role"></div></div>
      <button class="signout-btn" onclick="signOut()">Sign out</button>
    </div>
  </aside>

  <div class="main">
    <div class="topbar"><div class="page-title" id="page-title">Claude Agent</div></div>

    <!-- AGENT -->
    <div class="agent-screen active" id="screen-agent">
      <div class="agent-header-bar">
        <div class="agent-orb" style="width:32px;height:32px;"><svg viewBox="0 0 24 24" fill="white" width="14" height="14"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg></div>
        <div><div style="font-size:0.88rem;font-weight:600;color:var(--blue-deep);">Clasp Agent</div><div class="agent-status"><span class="agent-status-dot"></span>Ready to help</div></div>
        <div style="margin-left:auto;"><button class="btn-sm btn-ghost" onclick="clearChat()">Clear chat</button></div>
      </div>
      <div class="chat-area" id="chat-area"></div>
      <div class="suggestion-chips" id="suggestion-chips">
        <div class="chip" onclick="sendSuggestion(this)">Find VP Sales leads in fintech</div>
        <div class="chip" onclick="sendSuggestion(this)">Draft a cold outreach message</div>
        <div class="chip" onclick="sendSuggestion(this)">Write a LinkedIn connection note</div>
        <div class="chip" onclick="sendSuggestion(this)">Research a company before a call</div>
      </div>
      <div class="compose-bar">
        <div class="compose-inner">
          <textarea class="compose-textarea" id="chat-input" placeholder="Ask Claude anything about networking, leads, outreachâ€¦" rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button class="send-btn" id="send-btn" onclick="sendMessage()"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="screen-profile">
      <div class="profile-layout">
        <div>
          <!-- Profile Card -->
          <div class="white-card">
            <div class="profile-cover"></div>
            <div class="profile-identity">
              <div class="profile-av-wrap" style="position:relative;">
              <div class="profile-av" id="profile-av-display" style="overflow:hidden;">
                <img id="profile-av-img" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;" alt="avatar">
                <span id="profile-av-initials">?</span>
              </div>
              <label for="avatar-upload" style="position:absolute;bottom:0;right:0;width:22px;height:22px;background:var(--blue);border-radius:50%;border:2px solid white;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Upload photo">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="white"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              </label>
              <input type="file" id="avatar-upload" accept="image/*" style="display:none;" onchange="uploadAvatar(this)">
            </div>
              <div class="profile-name" id="profile-name-display">Your Name</div>
              <div class="profile-headline" id="profile-headline-display">Your title</div>
              <div class="profile-meta">
                <span class="profile-meta-item" id="profile-location-display"></span>
                <span class="profile-meta-item" id="profile-url-display"></span>
              </div>
            </div>
            <div style="padding:0 24px 16px;">
              <div class="profile-stats">
                <div class="stat-box"><div class="stat-num" id="stat-chats">0</div><div class="stat-label">Claude Chats</div></div>
                <div class="stat-box"><div class="stat-num" id="stat-drafts">0</div><div class="stat-label">Drafts Saved</div></div>
                <div class="stat-box"><div class="stat-num">âœ¦</div><div class="stat-label">AI Powered</div></div>
              </div>
            </div>
          </div>

          <!-- Edit Basic Info -->
          <div class="white-card">
            <div class="profile-section">
              <div class="section-heading">Basic Info</div>
              <div class="edit-form">
                <div class="form-row">
                  <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="input-name" type="text" placeholder="Your name" oninput="updateProfileDisplay()"></div>
                  <div class="form-group"><label class="form-label">Username</label><input class="form-input" id="input-username" type="text" placeholder="e.g. jordansmith"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label class="form-label">Job Title</label><input class="form-input" id="input-title" type="text" placeholder="e.g. VP of Sales" oninput="updateProfileDisplay()"></div>
                  <div class="form-group"><label class="form-label">Company</label><input class="form-input" id="input-company" type="text" placeholder="Your company"></div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label class="form-label">Location</label><input class="form-input" id="input-location" type="text" placeholder="City, State"></div>
                  <div class="form-group"><label class="form-label">Website / LinkedIn</label><input class="form-input" id="input-website" type="text" placeholder="https://"></div>
                </div>
                <div class="form-group"><label class="form-label">Headline</label><input class="form-input" id="input-headline" type="text" placeholder="e.g. Helping B2B teams close faster with AI"></div>
                <div class="form-group"><label class="form-label">About</label><textarea class="form-input form-textarea" id="input-about" placeholder="Your bio â€” Claude will write outreach in your voice"></textarea></div>
              </div>
            </div>
          </div>

          <!-- Skills -->
          <div class="white-card">
            <div class="profile-section">
              <div class="section-heading">Skills</div>
              <div class="skills-wrap" id="skills-display" style="margin-bottom:10px;"></div>
              <div style="display:flex;gap:8px;">
                <input class="form-input" id="skill-input" type="text" placeholder="Add a skillâ€¦" style="flex:1;" onkeydown="if(event.key==='Enter')addSkill()">
                <button class="btn-sm btn-ghost" onclick="addSkill()">Add</button>
              </div>
            </div>
          </div>

          <!-- Open To -->
          <div class="white-card">
            <div class="profile-section">
              <div class="section-heading">Open To</div>
              <div class="open-to-wrap" id="opento-display" style="margin-bottom:10px;"></div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;">
                <button class="btn-sm btn-ghost" onclick="toggleOpenTo('New opportunities')">New opportunities</button>
                <button class="btn-sm btn-ghost" onclick="toggleOpenTo('Partnerships')">Partnerships</button>
                <button class="btn-sm btn-ghost" onclick="toggleOpenTo('Investing')">Investing</button>
                <button class="btn-sm btn-ghost" onclick="toggleOpenTo('Advisory roles')">Advisory roles</button>
                <button class="btn-sm btn-ghost" onclick="toggleOpenTo('Speaking')">Speaking</button>
                <button class="btn-sm btn-ghost" onclick="toggleOpenTo('Mentoring')">Mentoring</button>
              </div>
            </div>
          </div>

          <!-- Experience -->
          <div class="white-card">
            <div class="profile-section">
              <div class="section-heading">Experience</div>
              <div id="exp-list" style="margin-bottom:16px;"></div>
              <div style="background:var(--bg);border-radius:10px;padding:16px;" id="exp-form">
                <div style="font-size:0.78rem;font-weight:600;color:var(--muted);margin-bottom:10px;">Add Experience</div>
                <div class="edit-form">
                  <div class="form-row">
                    <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="exp-title" type="text" placeholder="e.g. VP of Sales"></div>
                    <div class="form-group"><label class="form-label">Company</label><input class="form-input" id="exp-company" type="text" placeholder="Company name"></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label class="form-label">Start</label><input class="form-input" id="exp-start" type="text" placeholder="e.g. Jan 2022"></div>
                    <div class="form-group"><label class="form-label">End</label><input class="form-input" id="exp-end" type="text" placeholder="Present"></div>
                  </div>
                  <div class="form-group"><label class="form-label">Description</label><textarea class="form-input form-textarea" id="exp-desc" placeholder="What did you do?" style="min-height:60px;"></textarea></div>
                  <button class="btn-sm btn-blue" onclick="addExperience()" style="align-self:flex-start;">Add</button>
                </div>
              </div>
            </div>
          </div>

          <!-- ICP for Claude -->
          <div class="white-card">
            <div class="profile-section">
              <div class="section-heading">Your ICP â€” Claude uses this for lead searches</div>
              <div class="edit-form">
                <div class="form-group"><textarea class="form-input form-textarea" id="input-icp" placeholder="e.g. VP Sales at Series B+ SaaS companies, 50-500 employees, US-based"></textarea></div>
              </div>
            </div>
          </div>

          <button class="btn-save" onclick="saveProfile()" style="margin-top:4px;">Save Profile</button>
        </div>

        <div>
          <div class="side-card">
            <div class="side-title">Your public profile link</div>
            <div id="public-link" style="font-size:0.78rem;color:var(--blue);word-break:break-all;margin-bottom:10px;">Fill in a username above</div>
            <button class="btn-sm btn-ghost" onclick="copyPublicLink()" style="width:100%;justify-content:center;">Copy link</button>
          </div>
          <div class="side-card">
            <div class="side-title">What Claude does with your profile</div>
            <div style="font-size:0.8rem;color:var(--muted);line-height:1.9;">âœ¦ Writes outreach in your voice<br>âœ¦ Targets leads matching your ICP<br>âœ¦ Personalizes every message<br>âœ¦ Researches companies you care about</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PEOPLE DIRECTORY -->
    <div class="screen" id="screen-people">
      <div class="search-bar-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input class="search-input" type="text" id="people-search" placeholder="Search by name, title, company, or skillâ€¦" oninput="searchPeople(this.value)">
      </div>
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <button class="btn-sm btn-dark" onclick="askClaudeToSearch()">âœ¦ Ask Claude to find leads</button>
        <button class="btn-sm btn-ghost" onclick="filterByOpenTo('New opportunities')">Open to opportunities</button>
        <button class="btn-sm btn-ghost" onclick="filterByOpenTo('Partnerships')">Open to partnerships</button>
      </div>
      <div id="people-list"><div style="text-align:center;padding:48px;color:var(--light);">Loading membersâ€¦</div></div>
    </div>

    <!-- OUTREACH -->
    <div class="screen" id="screen-outreach">
      <div style="max-width:700px;">
        <div style="background:white;border-radius:var(--radius);border:1px solid var(--border);padding:24px;">
          <div style="font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--blue-deep);margin-bottom:16px;">Draft Outreach with Claude</div>
          <div class="edit-form">
            <div class="form-row">
              <div class="form-group"><label class="form-label">Recipient Name</label><input class="form-input" id="outreach-name" type="text" placeholder="e.g. Alex Morgan"></div>
              <div class="form-group"><label class="form-label">Their Role & Company</label><input class="form-input" id="outreach-role" type="text" placeholder="e.g. VP Sales at Stripe"></div>
            </div>
            <div class="form-group"><label class="form-label">Why are you reaching out?</label><textarea class="form-input form-textarea" id="outreach-reason" placeholder="e.g. Saw their post about AI, want to explore partnershipâ€¦"></textarea></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Message Type</label><select class="form-input" id="outreach-type"><option value="linkedin-connection">LinkedIn Connection Note</option><option value="linkedin-message">LinkedIn Message</option><option value="cold-email">Cold Email</option><option value="follow-up">Follow-up</option></select></div>
              <div class="form-group"><label class="form-label">Tone</label><select class="form-input" id="outreach-tone"><option value="professional">Professional</option><option value="warm">Warm & conversational</option><option value="direct">Direct & brief</option><option value="casual">Casual</option></select></div>
            </div>
            <button class="btn-save" onclick="generateOutreach()">âœ¦ Generate with Claude</button>
          </div>
        </div>
        <div id="outreach-result" style="display:none;margin-top:16px;background:white;border-radius:var(--radius);border:1px solid var(--border);padding:24px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
            <div style="font-family:'Syne',sans-serif;font-size:0.9rem;font-weight:700;color:var(--blue-deep);">Generated Message</div>
            <div style="display:flex;gap:8px;">
              <button class="btn-sm btn-ghost" onclick="copyOutreach()">Copy</button>
              <button class="btn-sm btn-ghost" onclick="saveDraft()">Save Draft</button>
              <button class="btn-sm btn-blue" onclick="generateOutreach()">âœ¦ Regenerate</button>
            </div>
          </div>
          <div id="outreach-text" style="font-size:0.88rem;line-height:1.75;color:var(--text);white-space:pre-wrap;background:var(--bg);border-radius:8px;padding:16px;"></div>
        </div>
      </div>
    </div>

    <!-- DRAFTS -->
    <div class="screen" id="screen-drafts">
      <div style="max-width:700px;">
        <div style="font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--blue-deep);margin-bottom:16px;">Saved Drafts</div>
        <div id="drafts-list"><div style="text-align:center;padding:48px;color:var(--light);font-size:0.88rem;">No drafts yet.</div></div>
      </div>
    </div>

    <!-- MESSAGES SCREEN -->
    <div class="screen" id="screen-messages">
      <div class="msg-screen-layout">
        <!-- Conversation list -->
        <div class="conv-list">
          <div class="conv-list-header">
            <span class="conv-list-title">Messages</span>
            <button class="btn-sm btn-dark" onclick="showNewDMModal()" style="padding:5px 10px;font-size:0.72rem;">+ New</button>
          </div>
          <div class="conv-search"><input type="text" placeholder="Search conversationsâ€¦" oninput="filterConvs(this.value)"></div>
          <div class="conv-items" id="conv-items">
            <div style="text-align:center;padding:32px 16px;color:var(--light);font-size:0.82rem;">No messages yet.<br>Start a conversation from the People screen.</div>
          </div>
        </div>
        <!-- Message window -->
        <div class="dm-window" id="dm-window">
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ’¬</div>
            <div class="empty-state-title">Your messages</div>
            <div class="empty-state-sub">Select a conversation or find someone in People to start messaging.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHANNELS SCREEN -->
    <div class="screen" id="screen-channels">
      <div class="channel-layout">
        <div class="channel-list">
          <div class="channel-list-header">
            <span class="conv-list-title">Channels</span>
            <button class="btn-sm btn-dark" onclick="showNewChannelModal()" style="padding:5px 10px;font-size:0.72rem;">+ New</button>
          </div>
          <div class="channel-items" id="channel-items">
            <div style="padding:8px;font-size:0.75rem;color:var(--light);">No channels yet</div>
          </div>
        </div>
        <div class="dm-window" id="channel-window">
          <div class="empty-state">
            <div class="empty-state-icon">#</div>
            <div class="empty-state-title">Team Channels</div>
            <div class="empty-state-sub">Create a channel for your team to share Claude learnings, prompts, and updates.</div>
            <button class="btn-save" onclick="showNewChannelModal()" style="margin-top:16px;align-self:center;">Create a channel</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PROFILE MODAL -->
<div class="profile-modal" id="profile-modal" onclick="if(event.target===this)closeProfileModal()">
  <div class="profile-modal-box" id="profile-modal-content" style="position:relative;">
    <button class="modal-close" onclick="closeProfileModal()">âœ• Close</button>
    <div id="modal-body"></div>
  </div>
</div>

<div class="toast" id="toast"><span style="color:var(--teal)">âœ¦</span><span id="toast-msg">Done!</span></div>

<div class="spotlight-overlay" id="spotlight" onclick="if(event.target===this)closeSpotlight()">
  <div class="spotlight-box">
    <div class="spot-input-row">
      <div class="spot-orb"><svg viewBox="0 0 24 24" fill="white"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg></div>
      <input class="spot-input" id="spot-input" placeholder="Ask Claude to find leads, draft a messageâ€¦" onkeydown="if(event.key==='Escape')closeSpotlight();if(event.key==='Enter')spotAction(this.value)">
      <span class="spot-esc">Esc</span>
    </div>
    <div class="spot-suggestions">
      <div class="spot-label">Quick actions</div>
      <div class="spot-item" onclick="spotAction('Find VP Sales leads at Series B SaaS companies')"><div class="spot-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div><div><div class="spot-title">Find VP Sales leads at Series B SaaS</div><div class="spot-sub">Lead search</div></div></div>
      <div class="spot-item" onclick="spotAction('Draft a LinkedIn connection note for cold outreach')"><div class="spot-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div><div><div class="spot-title">Draft a LinkedIn connection note</div><div class="spot-sub">Outreach</div></div></div>
      <div class="spot-item" onclick="spotAction('Write a follow-up for a prospect who went cold')"><div class="spot-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div><div><div class="spot-title">Write a follow-up for a cold prospect</div><div class="spot-sub">Outreach</div></div></div>
    </div>
    <div class="spot-footer"><span class="spot-hint"><kbd>â†µ</kbd> send to Claude</span><span class="spot-hint"><kbd>Esc</kbd> close</span></div>
  </div>
</div>

<script>
const{createClient}=supabase;
const sb=createClient('https://exfejbtwxqczcghwfjyw.supabase.co','sb_publishable_0wsYlW-72LC8AxHCdgavQQ_I7-lu1RC');
let currentUser=null,userProfile={},chatHistory=[],isLoading=false,currentTab='signin';
let userSkills=[],userOpenTo=[],userExperience=[];

// â”€â”€ INIT â”€â”€

// â”€â”€ MESSAGING â”€â”€
let activeConvUserId = null;
let activeChannelId = null;
let dmSubscription = null;
let allConvs = [];

async function loadConversations() {
  // Get all unique users we've had conversations with
  const { data: sent } = await sb.from('messages').select('recipient_id').eq('sender_id', currentUser.id);
  const { data: recv } = await sb.from('messages').select('sender_id').eq('recipient_id', currentUser.id);
  const userIds = [...new Set([
    ...(sent||[]).map(m=>m.recipient_id),
    ...(recv||[]).map(m=>m.sender_id)
  ])];
  if (!userIds.length) return;

  // Get profiles for those users
  const { data: profiles } = await sb.from('profiles').select('id,name,title,company').in('id', userIds);
  allConvs = profiles || [];
  renderConvList(allConvs);
  checkUnread();
}

function renderConvList(convs) {
  const el = document.getElementById('conv-items');
  if (!el) return;
  if (!convs.length) {
    el.innerHTML = '<div style="text-align:center;padding:32px 16px;color:var(--light);font-size:0.82rem;">No messages yet.<br>Start a conversation from the People screen.</div>';
    return;
  }
  const colors = ['linear-gradient(135deg,#0A66C2,#00B4A6)','linear-gradient(135deg,#004182,#0073B1)'];
  el.innerHTML = convs.map((p,i) => 
    '<div class="conv-item' + (activeConvUserId===p.id?' active':'') + '" onclick="openDM(\''+p.id+'\',\''+p.name.replace(/'/g,'')+'\',\''+((p.title||'')+(p.company?' at '+p.company:'')).replace(/'/g,'')+'\')">'+ 
    '<div class="conv-av" style="background:'+colors[i%colors.length]+'">'+ini(p.name)+'</div>'+
    '<div style="flex:1;min-width:0;">'+
      '<div class="conv-name">'+p.name+'</div>'+
      '<div class="conv-preview">'+(p.title||'')+(p.company?' Â· '+p.company:'')+'</div>'+
    '</div>'+
    '</div>'
  ).join('');
}

function filterConvs(q) {
  const filtered = allConvs.filter(p => (p.name+' '+(p.title||'')+' '+(p.company||'')).toLowerCase().includes(q.toLowerCase()));
  renderConvList(filtered);
}

async function openDM(userId, name, role) {
  activeConvUserId = userId;
  renderConvList(allConvs); // re-render to show active state

  const win = document.getElementById('dm-window');
  win.innerHTML = 
    '<div class="dm-header">'+
      '<div class="dm-header-av">'+ini(name)+'</div>'+
      '<div><div class="dm-header-name">'+name+'</div><div class="dm-header-role">'+role+'</div></div>'+
      '<div style="margin-left:auto;display:flex;gap:8px;">'+
        '<button class="btn-sm btn-dark" onclick="draftOutreachFor(\''+name+'\',\''+role+'\')" style="font-size:0.72rem;">âœ¦ Draft outreach</button>'+
        '<button class="btn-sm btn-dark" onclick="askClaudeAboutPerson(\''+name+'\',\''+role+'\')" style="font-size:0.72rem;">âœ¦ Ask Claude</button>'+
      '</div>'+
    '</div>'+
    '<div class="dm-messages" id="dm-msgs"></div>'+
    '<div id="claude-suggestion-area"></div>'+
    '<div class="dm-compose">'+
      '<div class="dm-compose-inner">'+
        '<textarea class="dm-textarea" id="dm-input" placeholder="Message '+name+'\u2026" rows="1" oninput="autoResize(this)" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendDM(\''+userId+'\',\''+name+'\',\''+role+'\')}"></textarea>'+
        '<button class="send-btn" onclick="sendDM(\''+userId+'\',\''+name+'\',\''+role+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>'+
      '</div>'+
    '</div>';

  await loadDMMessages(userId);
  
  // Subscribe to real-time messages
  if (dmSubscription) { dmSubscription.unsubscribe(); dmSubscription = null; }
  dmSubscription = sb.channel('dm-'+currentUser.id+'-'+userId)
    .on('postgres_changes', { 
      event: 'INSERT', schema: 'public', table: 'messages',
      filter: 'recipient_id=eq.'+currentUser.id
    }, payload => {
      const m = payload.new;
      if (m.sender_id === userId) {
        appendDMMsg('theirs', m.content, name);
        // Mark as read
        sb.from('messages').update({ read: true }).eq('id', m.id);
        checkUnread();
      }
    }).subscribe();
}

async function loadDMMessages(userId) {
  const { data } = await sb.from('messages')
    .select('*')
    .or('and(sender_id.eq.'+currentUser.id+',recipient_id.eq.'+userId+'),and(sender_id.eq.'+userId+',recipient_id.eq.'+currentUser.id+')')
    .order('created_at', { ascending: true });
  
  const area = document.getElementById('dm-msgs');
  if (!area) return;
  if (!data || !data.length) {
    area.innerHTML = '<div style="text-align:center;padding:24px;color:var(--light);font-size:0.82rem;">No messages yet â€” say hello!</div>';
    return;
  }
  area.innerHTML = '';
  
  // Get their name for display
  const { data: profile } = await sb.from('profiles').select('name').eq('id', userId).single();
  const theirName = profile?.name || 'them';
  
  data.forEach(m => appendDMMsg(m.sender_id === currentUser.id ? 'mine' : 'theirs', m.content, theirName));
  area.scrollTop = area.scrollHeight;

  // Mark as read
  await sb.from('messages').update({ read: true }).eq('recipient_id', currentUser.id).eq('sender_id', userId);
}

function appendDMMsg(side, text, theirName) {
  const area = document.getElementById('dm-msgs');
  if (!area) return;
  const time = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const isMine = side === 'mine';
  const name = isMine ? (userProfile.name||'Me') : theirName;
  const div = document.createElement('div');
  div.className = 'dm-msg ' + (isMine ? 'mine' : '');
  div.innerHTML = 
    '<div class="dm-msg-av">'+ini(name)+'</div>'+
    '<div><div class="dm-bubble">'+fmt(text)+'</div><div class="dm-time">'+time+'</div></div>';
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

async function sendDM(userId, name, role) {
  const input = document.getElementById('dm-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = ''; autoResize(input);
  document.getElementById('claude-suggestion-area').innerHTML = '';
  
  const { error } = await sb.from('messages').insert({
    sender_id: currentUser.id,
    recipient_id: userId,
    content: text
  });
  if (error) { showToast('Error sending message'); return; }
  appendDMMsg('mine', text, name);
  
  // Add to conv list if not there
  if (!allConvs.find(c => c.id === userId)) {
    await loadConversations();
  }
}

// Claude reply suggestion
let suggestTimeout = null;
function suggestReply() {
  clearTimeout(suggestTimeout);
  suggestTimeout = setTimeout(async () => {
    const input = document.getElementById('dm-input');
    if (!input || input.value.length > 0) return; // only suggest when input is empty after clearing
  }, 2000);
}

async function askClaudeAboutPerson(name, role) {
  switchScreen('agent', document.querySelectorAll('.nav-item')[0]);
  setTimeout(() => {
    document.getElementById('chat-input').value = 'Research ' + name + ' (' + role + ') for me before I message them. What should I know?';
    sendMessage();
  }, 100);
}

async function generateClaudeDMSuggestion(name, role, lastMsg) {
  const area = document.getElementById('claude-suggestion-area');
  if (!area) return;
  area.innerHTML = '<div class="claude-suggestion"><div class="agent-orb" style="width:24px;height:24px;flex-shrink:0;"><svg viewBox="0 0 24 24" fill="white" width="10" height="10"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg></div><div class="claude-suggestion-text"><div class="claude-suggestion-label">CLAUDE SUGGESTS</div>Thinking of a replyâ€¦</div></div>';
  
  try {
    const r = await fetch('/.netlify/functions/claude', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        system: getSys(),
        messages: [{ role: 'user', content: 'Draft a short reply to ' + name + ' (' + role + '). Their last message: "' + lastMsg + '". Keep it natural and under 2 sentences. Just the reply text, no preamble.' }]
      })
    });
    const d = await r.json();
    const suggestion = d.content?.[0]?.text || '';
    if (!suggestion) { area.innerHTML = ''; return; }
    area.innerHTML = 
      '<div class="claude-suggestion">'+
        '<div class="agent-orb" style="width:24px;height:24px;flex-shrink:0;"><svg viewBox="0 0 24 24" fill="white" width="10" height="10"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg></div>'+
        '<div class="claude-suggestion-text"><div class="claude-suggestion-label">CLAUDE SUGGESTS â€” click Approve to use</div>'+suggestion+'</div>'+
        '<button class="approve-btn" id="approve-dm-btn">Approve âœ“</button>'+
        '<button class="dismiss-btn" id="dismiss-dm-btn">âœ•</button>'+
      '</div>';
    window._pendingSuggestion = suggestion;
    setTimeout(() => {
      const ab = document.getElementById('approve-dm-btn');
      const db = document.getElementById('dismiss-dm-btn');
      if(ab) ab.onclick = () => approveDMSuggestion(window._pendingSuggestion);
      if(db) db.onclick = () => { document.getElementById('claude-suggestion-area').innerHTML=''; };
    }, 50);
  } catch(e) { area.innerHTML = ''; }
}

async function approveDMSuggestion(text) {
  const input = document.getElementById('dm-input');
  if (input) { input.value = text; input.focus(); }
  document.getElementById('claude-suggestion-area').innerHTML = '';
}

async function startDMWith(userId, name, role) {
  switchScreen('messages', document.getElementById('nav-messages'));
  await loadConversations();
  setTimeout(() => openDM(userId, name, role), 100);
}

function showNewDMModal() {
  switchScreen('people', document.querySelectorAll('.nav-item')[2]);
  showToast('Find someone in People and click Message');
}

async function checkUnread() {
  const { count } = await sb.from('messages').select('*', {count:'exact',head:true}).eq('recipient_id', currentUser.id).eq('read', false);
  const badge = document.getElementById('msg-badge');
  if (badge) {
    if (count > 0) { badge.textContent = count; badge.style.display = 'inline'; }
    else badge.style.display = 'none';
  }
}

// â”€â”€ CHANNELS â”€â”€
async function loadChannels() {
  const { data } = await sb.from('channel_members').select('channel_id, channels(id,name,description)').eq('user_id', currentUser.id);
  const channels = (data||[]).map(r => r.channels).filter(Boolean);
  const el = document.getElementById('channel-items');
  if (!el) return;
  if (!channels.length) {
    el.innerHTML = '<div style="padding:8px;font-size:0.75rem;color:var(--light);">No channels yet</div>';
    return;
  }
  el.innerHTML = channels.map(c => 
    '<div class="channel-item'+(activeChannelId===c.id?' active':'')+'" onclick="openChannel(\''+c.id+'\',\''+c.name+'\')">'+
    '<span class="channel-hash">#</span>'+c.name+'</div>'
  ).join('');
}

let channelSubscription = null;

async function openChannel(channelId, name) {
  activeChannelId = channelId;
  await loadChannels();
  
  // Real-time channel messages
  if (channelSubscription) { channelSubscription.unsubscribe(); channelSubscription = null; }
  channelSubscription = sb.channel('channel-'+channelId)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'channel_messages',
      filter: 'channel_id=eq.'+channelId
    }, async payload => {
      const m = payload.new;
      if (m.sender_id === currentUser.id) return; // already rendered
      // Get sender name
      const { data: prof } = await sb.from('profiles').select('name').eq('id', m.sender_id).single();
      const senderName = prof?.name || 'Someone';
      const area = document.getElementById('channel-msgs');
      if (!area) return;
      const div = document.createElement('div');
      div.className = 'dm-msg';
      div.innerHTML = '<div class="dm-msg-av">'+ini(senderName)+'</div><div><div class="dm-bubble">'+fmt(m.content)+'</div><div class="dm-time">'+senderName+' Â· '+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</div></div>';
      area.appendChild(div);
      area.scrollTop = area.scrollHeight;
    }).subscribe();
  const win = document.getElementById('channel-window');
  win.innerHTML = 
    '<div class="dm-header">'+
      '<div style="width:32px;height:32px;border-radius:8px;background:var(--blue-deep);display:flex;align-items:center;justify-content:center;color:white;font-size:1rem;font-weight:700;">#</div>'+
      '<div><div class="dm-header-name">#'+name+'</div></div>'+
      '<div style="margin-left:auto;"><button class="btn-sm btn-dark" onclick="askClaudeForChannel(\''+name+'\')" style="font-size:0.72rem;">âœ¦ Ask Claude</button></div>'+
    '</div>'+
    '<div class="dm-messages" id="channel-msgs"></div>'+
    '<div class="dm-compose">'+
      '<div class="dm-compose-inner">'+
        '<textarea class="dm-textarea" id="channel-input" placeholder="Message #'+name+'\u2026" rows="1" oninput="autoResize(this)" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();sendChannelMsg(\''+channelId+'\')}"></textarea>'+
        '<button class="send-btn" onclick="sendChannelMsg(\''+channelId+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>'+
      '</div>'+
    '</div>';

  // Load messages
  const { data } = await sb.from('channel_messages').select('*, profiles(name)').eq('channel_id', channelId).order('created_at', { ascending: true });
  const area = document.getElementById('channel-msgs');
  if (!data || !data.length) {
    area.innerHTML = '<div style="text-align:center;padding:24px;color:var(--light);font-size:0.82rem;">No messages yet â€” say something!</div>';
  } else {
    data.forEach(m => {
      const isMine = m.sender_id === currentUser.id;
      const div = document.createElement('div');
      div.className = 'dm-msg ' + (isMine ? 'mine' : '');
      div.innerHTML = '<div class="dm-msg-av">'+ini(m.profiles?.name||'?')+'</div><div><div class="dm-bubble">'+fmt(m.content)+'</div><div class="dm-time">'+m.profiles?.name+' Â· '+new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</div></div>';
      area.appendChild(div);
    });
    area.scrollTop = area.scrollHeight;
  }
}

async function sendChannelMsg(channelId) {
  const input = document.getElementById('channel-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = ''; autoResize(input);

  // Render user message first
  const area = document.getElementById('channel-msgs');
  if (!area) { console.error('channel-msgs not found'); return; }

  // Save message to DB (non-blocking)
  sb.from('channel_messages').insert({ channel_id: channelId, sender_id: currentUser.id, content: text });
  const div = document.createElement('div');
  div.className = 'dm-msg mine';
  div.innerHTML = '<div class="dm-msg-av">'+ini(userProfile.name||'Me')+'</div><div><div class="dm-bubble">'+fmt(text)+'</div><div class="dm-time">'+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</div></div>';
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;

  // Check if @Claude is mentioned
  if (text.toLowerCase().includes('@claude')) {
    // Show typing indicator
    const tid = 'ct'+Date.now();
    const tdiv = document.createElement('div');
    tdiv.className = 'dm-msg'; tdiv.id = tid;
    tdiv.innerHTML = '<div class="dm-msg-av" style="background:linear-gradient(135deg,var(--blue),var(--teal));"><svg viewBox="0 0 24 24" fill="white" width="10" height="10"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg></div><div class="dm-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>';
    area.appendChild(tdiv);
    area.scrollTop = area.scrollHeight;

    try {
      // Get recent channel context
      const { data: recentMsgs } = await sb.from('channel_messages')
        .select('content, profiles(name)')
        .eq('channel_id', channelId)
        .order('created_at', { ascending: false })
        .limit(10);
      
      const context = (recentMsgs||[]).reverse().map(function(m){return (m.profiles&&m.profiles.name?m.profiles.name:'Someone') + ': ' + m.content;}).join(' | ');
      
      const r = await fetch('/.netlify/functions/claude', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          system: getSys() + ' You are also in a team channel. Be concise. Context: ' + context,
          messages: [{ role: 'user', content: text.replace(/@claude/gi, 'Claude') }]
        })
      });
      const d = await r.json();
      const reply = d.content?.[0]?.text || 'Sorry, I could not respond right now.';

      // Remove typing indicator
      document.getElementById(tid)?.remove();

      // Save Claude's response to channel
      await sb.from('channel_messages').insert({ 
        channel_id: channelId, 
        sender_id: currentUser.id, // use current user as proxy for Claude
        content: 'âœ¦ Claude: ' + reply 
      });

      // Render Claude response
      const cdiv = document.createElement('div');
      cdiv.className = 'dm-msg';
      cdiv.innerHTML = '<div class="dm-msg-av" style="background:linear-gradient(135deg,var(--blue),var(--teal));"><svg viewBox="0 0 24 24" fill="white" width="10" height="10"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg></div><div><div class="dm-bubble" style="border-color:var(--blue-light);"><div style="font-size:0.68rem;color:var(--blue);font-weight:600;margin-bottom:4px;">âœ¦ CLAUDE</div>'+fmt(reply)+'</div><div class="dm-time">'+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</div></div>';
      area.appendChild(cdiv);
      area.scrollTop = area.scrollHeight;

    } catch(e) {
      console.error('Claude channel error:', e);
      document.getElementById(tid)?.remove();
      const area2 = document.getElementById('channel-msgs');
      if(area2){
        const ediv = document.createElement('div');
        ediv.className = 'dm-msg';
        ediv.innerHTML = '<div class="dm-msg-av" style="background:var(--red);">!</div><div><div class="dm-bubble" style="color:var(--red);">Claude error: ' + e.message + '</div></div>';
        area2.appendChild(ediv);
      }
    }
  }
}

function askClaudeForChannel(name) {
  switchScreen('agent', document.querySelectorAll('.nav-item')[0]);
  setTimeout(() => {
    document.getElementById('chat-input').value = 'Summarize the key learnings from our #' + name + ' channel and suggest what we should discuss next.';
    sendMessage();
  }, 100);
}

function showNewChannelModal() {
  const name = prompt('Channel name (e.g. sales-team, ai-learnings):');
  if (!name) return;
  createChannel(name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,''));
}

async function createChannel(name) {
  const { data, error } = await sb.from('channels').insert({ name, created_by: currentUser.id }).select().single();
  if (error) { showToast('Error creating channel'); return; }
  await sb.from('channel_members').insert({ channel_id: data.id, user_id: currentUser.id });
  showToast('#' + name + ' created!');
  await loadChannels();
  openChannel(data.id, name);
}


// â”€â”€ AVATAR UPLOAD â”€â”€
async function uploadAvatar(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 2 * 1024 * 1024) { showToast('Image must be under 2MB'); return; }
  
  showToast('Uploading photoâ€¦');
  const ext = file.name.split('.').pop();
  const path = currentUser.id + '/avatar.' + ext;
  
  const { error } = await sb.storage.from('avatars').upload(path, file, { upsert: true });
  if (error) { showToast('Upload failed â€” ' + error.message); return; }
  
  const { data } = sb.storage.from('avatars').getPublicUrl(path);
  const url = data.publicUrl + '?t=' + Date.now();
  
  userProfile.avatar_url = url;
  showAvatarImage(url);
  
  // Save to profile
  await sb.from('profiles').update({ avatar_url: url }).eq('id', currentUser.id);
  showToast('Photo updated!');
}

function showAvatarImage(url) {
  if (!url) return;
  const img = document.getElementById('profile-av-img');
  const initials = document.getElementById('profile-av-initials');
  const avDisplay = document.getElementById('profile-av-display');
  
  if (img) {
    img.onload = () => {
      img.style.display = 'block';
      if (initials) initials.style.display = 'none';
    };
    img.onerror = () => console.error('Avatar failed to load:', url);
    img.src = url;
  }
  
  // Update sidebar avatar
  const sav = document.getElementById('sidebar-av');
  if (sav) {
    const si = document.createElement('img'); si.src=url; si.style.cssText='width:34px;height:34px;border-radius:50%;object-fit:cover;'; sav.innerHTML=''; sav.appendChild(si);
  }
}

function getAvatarHtml(avatarUrl, name, size) {
  const sz = size || 36;
  if (avatarUrl) {
    return '<img src="'+avatarUrl+'" style="width:'+sz+'px;height:'+sz+'px;border-radius:50%;object-fit:cover;" alt="'+name+'">';
  }
  return ini(name||'?');
}

async function init(){
  if(window.location.hash==='#signup')switchTab('signup');
  const{data:{session}}=await sb.auth.getSession();
  if(session?.user)await loginSuccess(session.user);
  sb.auth.onAuthStateChange(async(event,session)=>{
    if(event==='SIGNED_IN'&&session?.user)await loginSuccess(session.user);
    else if(event==='SIGNED_OUT')showAuth();
  });
}

async function loginSuccess(user){
  currentUser=user;
  document.getElementById('auth-screen').classList.remove('visible');
  document.getElementById('app').style.display='flex';
  await loadProfile();
  await loadChatHistory();
  await loadDraftsCount();
  loadPeople();
  loadConversations();
  setInterval(checkUnread, 30000);
}

function showAuth(){
  currentUser=null;
  document.getElementById('app').style.display='none';
  document.getElementById('auth-screen').classList.add('visible');
}

// â”€â”€ AUTH â”€â”€
function switchTab(tab){
  currentTab=tab;
  document.getElementById('tab-signin').classList.toggle('active',tab==='signin');
  document.getElementById('tab-signup').classList.toggle('active',tab==='signup');
  document.getElementById('auth-submit-btn').textContent=tab==='signin'?'Sign In':'Create Account';
  document.getElementById('auth-name').style.display=tab==='signup'?'block':'none';
  document.getElementById('auth-error').style.display='none';
  document.getElementById('auth-success').style.display='none';
}

async function authSubmit(){
  const email=document.getElementById('auth-email').value.trim();
  const password=document.getElementById('auth-password').value;
  const name=document.getElementById('auth-name').value.trim();
  const btn=document.getElementById('auth-submit-btn');
  if(!email||!password){showAuthError('Please enter your email and password.');return;}
  btn.disabled=true;btn.textContent='Please waitâ€¦';
  document.getElementById('auth-error').style.display='none';
  document.getElementById('auth-success').style.display='none';
  if(currentTab==='signup'){
    const{error}=await sb.auth.signUp({email,password,options:{data:{full_name:name}}});
    if(error){showAuthError(error.message);btn.disabled=false;btn.textContent='Create Account';return;}
    const s=document.getElementById('auth-success');
    s.textContent='Account created! Check your email to confirm, then sign in.';s.style.display='block';
    btn.disabled=false;btn.textContent='Create Account';
  }else{
    const{error}=await sb.auth.signInWithPassword({email,password});
    if(error){showAuthError('Incorrect email or password.');btn.disabled=false;btn.textContent='Sign In';}
  }
}

async function signInWithGoogle(){
  await sb.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.href}});
}
async function signOut(){await sb.auth.signOut();}
function showAuthError(msg){const e=document.getElementById('auth-error');e.textContent=msg;e.style.display='block';}

// â”€â”€ PROFILE â”€â”€
async function loadProfile(){
  const{data}=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
  if(data){
    userProfile=data;
    userSkills=data.skills||[];
    userOpenTo=data.open_to||[];
    userExperience=data.experience||[];
    const fields=['name','title','company','location','about','icp','username','headline','website','avatar_url'];
    fields.forEach(f=>{const el=document.getElementById('input-'+f);if(el&&data[f])el.value=data[f];});
  }else{
    const name=currentUser.user_metadata?.full_name||currentUser.email?.split('@')[0]||'';
    if(name)document.getElementById('input-name').value=name;
    userProfile={name};
  }
  updateProfileDisplay();
  renderSkills();
  renderOpenTo();
  renderExperience();
  if(data && data.avatar_url) showAvatarImage(data.avatar_url);
}

function updateProfileDisplay(){
  const name=document.getElementById('input-name').value||'Your Name';
  const title=document.getElementById('input-title').value||'';
  const company=document.getElementById('input-company').value||'';
  const location=document.getElementById('input-location').value||'';
  const website=document.getElementById('input-website').value||'';
  const username=document.getElementById('input-username').value||'';
  const headline=document.getElementById('input-headline').value||(title+(company?' at '+company:''));
  document.getElementById('profile-name-display').textContent=name;
  document.getElementById('profile-headline-display').textContent=headline;
  document.getElementById('profile-av-display').textContent=ini(name);
  document.getElementById('sidebar-av').textContent=ini(name);
  document.getElementById('sidebar-name').textContent=name;
  document.getElementById('sidebar-role').textContent=title+(company?' Â· '+company:'');
  const locEl=document.getElementById('profile-location-display');
  if(locEl)locEl.textContent=location;
  const urlEl=document.getElementById('profile-url-display');
  if(urlEl&&website)urlEl.innerHTML='<a href="'+website+'" target="_blank" style="color:var(--blue);">'+website.replace('https://','')+'</a>';
  const linkEl=document.getElementById('public-link');
  if(linkEl)linkEl.textContent=username?'getclasp.io/u/'+username:'Fill in a username above';
}

async function saveProfile(){
  const p={
    id:currentUser.id,
    name:document.getElementById('input-name').value,
    title:document.getElementById('input-title').value,
    company:document.getElementById('input-company').value,
    location:document.getElementById('input-location').value,
    about:document.getElementById('input-about').value,
    icp:document.getElementById('input-icp').value,
    username:document.getElementById('input-username').value.toLowerCase().replace(/[^a-z0-9]/g,''),
    headline:document.getElementById('input-headline').value,
    website:document.getElementById('input-website').value,
    skills:userSkills,
    open_to:userOpenTo,
    experience:userExperience,
    is_public:true,
    avatar_url:userProfile.avatar_url||''
  };
  const{error}=await sb.from('profiles').upsert(p);
  if(error){
    if(error.message.includes('unique'))showToast('Username already taken â€” try another!');
    else showToast('Error saving â€” please try again');
    return;
  }
  userProfile=p;updateProfileDisplay();
  showToast('Profile saved!');
}

// Skills
function renderSkills(){
  const wrap=document.getElementById('skills-display');
  if(!wrap)return;
  wrap.innerHTML=userSkills.map((s,i)=>'<span class="skill-tag removable" onclick="removeSkill('+i+')" title="Click to remove">'+s+' Ã—</span>').join('');
}
function addSkill(){
  const input=document.getElementById('skill-input');
  const val=input.value.trim();
  if(!val||userSkills.includes(val))return;
  userSkills.push(val);input.value='';renderSkills();
}
function removeSkill(i){userSkills.splice(i,1);renderSkills();}

// Open To
function renderOpenTo(){
  const wrap=document.getElementById('opento-display');
  if(!wrap)return;
  wrap.innerHTML=userOpenTo.map((s,i)=>'<span class="open-tag" onclick="removeOpenTo('+i+')" style="cursor:pointer;" title="Click to remove">'+s+' Ã—</span>').join('');
}
function toggleOpenTo(val){
  const idx=userOpenTo.indexOf(val);
  if(idx>-1)userOpenTo.splice(idx,1);else userOpenTo.push(val);
  renderOpenTo();
}
function removeOpenTo(i){userOpenTo.splice(i,1);renderOpenTo();}

// Experience
function renderExperience(){
  const list=document.getElementById('exp-list');
  if(!list)return;
  if(!userExperience.length){list.innerHTML='<div style="font-size:0.8rem;color:var(--light);margin-bottom:8px;">No experience added yet.</div>';return;}
  list.innerHTML=userExperience.map((e,i)=>'<div class="exp-item"><div style="display:flex;justify-content:space-between;"><div><div class="exp-title">'+e.title+'</div><div class="exp-company">'+e.company+'</div><div class="exp-dates">'+e.start+' â€” '+(e.end||'Present')+'</div>'+(e.desc?'<div style="font-size:0.78rem;color:var(--muted);margin-top:4px;">'+e.desc+'</div>':'')+'</div><button class="btn-sm btn-ghost" onclick="removeExp('+i+')" style="height:fit-content;">Remove</button></div></div>').join('');
}
function addExperience(){
  const title=document.getElementById('exp-title').value.trim();
  const company=document.getElementById('exp-company').value.trim();
  if(!title||!company)return;
  userExperience.unshift({title,company,start:document.getElementById('exp-start').value,end:document.getElementById('exp-end').value,desc:document.getElementById('exp-desc').value});
  ['exp-title','exp-company','exp-start','exp-end','exp-desc'].forEach(id=>document.getElementById(id).value='');
  renderExperience();
}
function removeExp(i){userExperience.splice(i,1);renderExperience();}

function copyPublicLink(){
  const username=document.getElementById('input-username').value;
  if(!username){showToast('Add a username first!');return;}
  navigator.clipboard.writeText('https://getclasp.io/u/'+username).then(()=>showToast('Profile link copied!'));
}

// â”€â”€ PEOPLE DIRECTORY â”€â”€
let allPeople=[];

async function loadPeople(){
  const{data}=await sb.from('profiles')
    .select('id,name,title,company,location,skills,open_to,headline,username,about,avatar_url')
    .eq('is_public',true)
    .not('name','is',null)
    .order('created_at',{ascending:false})
    .limit(100);
  allPeople=data||[];
  renderPeople(allPeople);
}

function renderPeople(people){
  const list=document.getElementById('people-list');
  if(!list)return;
  if(!people.length){
    list.innerHTML='<div style="text-align:center;padding:48px;color:var(--light);font-size:0.88rem;">No members found. Be the first to complete your profile!</div>';
    return;
  }
  const colors=['linear-gradient(135deg,#0A66C2,#00B4A6)','linear-gradient(135deg,#004182,#0073B1)','linear-gradient(135deg,#0073B1,#00B4A6)','linear-gradient(135deg,#1E3A5F,#0A66C2)','linear-gradient(135deg,#0A66C2,#004182)'];
  list.innerHTML=people.filter(p=>p.name).map((p,idx)=>{
    const skills=(p.skills||[]).slice(0,3).map(s=>'<span class="ptag">'+s+'</span>').join('');
    const openTo=(p.open_to||[]).slice(0,2).map(s=>'<span class="otag">'+s+'</span>').join('');
    return '<div class="person-card" onclick="openProfile(\''+p.id+'\')">'+
      '<div class="person-av" style="background:'+colors[idx%colors.length]+'">'+ini(p.name)+'</div>'+
      '<div style="flex:1;">'+
        '<div class="person-name">'+p.name+'</div>'+
        '<div class="person-role">'+(p.title||'')+(p.company?' Â· '+p.company:'')+'</div>'+
        (p.location?'<div style="font-size:0.72rem;color:var(--light);margin-top:2px;">'+p.location+'</div>':'')+
        (skills||openTo?'<div class="person-tags" style="margin-top:8px;">'+skills+openTo+'</div>':'')+
      '</div>'+
      '<div class="person-actions">'+
        '<button class="btn-sm btn-dark" onclick="event.stopPropagation();draftOutreachFor(\''+p.name+'\',\''+(p.title||'')+(p.company?' at '+p.company:'')+'\')">âœ¦ Draft outreach</button>'+
        '<button class="btn-sm btn-ghost" onclick="event.stopPropagation();openProfile(\''+p.id+'\')">View profile</button>'+
        '<button class="btn-sm btn-ghost" onclick="event.stopPropagation();startDMWith(\''+p.id+'\',\''+p.name.replace(/\x27/g,'')+'\',' + "'" + (p.title||'')+(p.company?' at '+p.company:'')+ "'" + ')" style="font-size:0.72rem;">ðŸ’¬ Message</button>'+
      '</div>'+
    '</div>';
  }).join('');
}

function searchPeople(q){
  if(!q){renderPeople(allPeople);return;}
  const filtered=allPeople.filter(p=>{
    const search=(p.name+' '+(p.title||'')+' '+(p.company||'')+' '+(p.skills||[]).join(' ')).toLowerCase();
    return search.includes(q.toLowerCase());
  });
  renderPeople(filtered);
}

function filterByOpenTo(val){
  const filtered=allPeople.filter(p=>(p.open_to||[]).includes(val));
  renderPeople(filtered);
}

// â”€â”€ PROFILE MODAL â”€â”€
async function openProfile(userId){
  const{data}=await sb.from('profiles').select('*').eq('id',userId).single();
  if(!data)return;
  const colors=['linear-gradient(135deg,#0A66C2,#00B4A6)','linear-gradient(135deg,#004182,#0073B1)'];
  const skills=(data.skills||[]).map(s=>'<span class="skill-tag">'+s+'</span>').join('');
  const openTo=(data.open_to||[]).map(s=>'<span class="open-tag">'+s+'</span>').join('');
  const exp=(data.experience||[]).map(e=>'<div class="exp-item"><div class="exp-title">'+e.title+'</div><div class="exp-company">'+e.company+'</div><div class="exp-dates">'+e.start+' â€” '+(e.end||'Present')+'</div>'+(e.desc?'<div style="font-size:0.78rem;color:var(--muted);margin-top:4px;">'+e.desc+'</div>':'')+'</div>').join('');

  document.getElementById('modal-body').innerHTML=
    '<div style="height:80px;background:linear-gradient(135deg,'+( colors[0])+')"></div>'+
    '<div style="padding:0 24px 24px;">'+
      '<div style="margin-top:-28px;margin-bottom:10px;">'+
        (data.avatar_url 
          ? '<img src="'+data.avatar_url+'" style="width:56px;height:56px;border-radius:50%;border:3px solid white;object-fit:cover;">'
          : '<div style="width:56px;height:56px;border-radius:50%;border:3px solid white;background:'+colors[0]+';display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:1.1rem;">'+ini(data.name)+'</div>')+
      '</div>'+
      '<div style="font-family:Syne,sans-serif;font-size:1.2rem;font-weight:700;color:var(--blue-deep);">'+data.name+'</div>'+
      '<div style="font-size:0.88rem;color:var(--muted);margin-top:2px;">'+(data.headline||((data.title||'')+(data.company?' at '+data.company:'')))+'</div>'+
      (data.location?'<div style="font-size:0.78rem;color:var(--light);margin-top:4px;">'+data.location+'</div>':'')+
      (data.about?'<div style="margin-top:16px;font-size:0.85rem;line-height:1.7;color:var(--text);">'+data.about+'</div>':'')+
      (openTo?'<div style="margin-top:16px;"><div style="font-size:0.75rem;font-weight:600;color:var(--muted);margin-bottom:6px;">OPEN TO</div><div style="display:flex;flex-wrap:wrap;gap:6px;">'+openTo+'</div></div>':'')+
      (skills?'<div style="margin-top:16px;"><div style="font-size:0.75rem;font-weight:600;color:var(--muted);margin-bottom:6px;">SKILLS</div><div style="display:flex;flex-wrap:wrap;gap:6px;">'+skills+'</div></div>':'')+
      (exp?'<div style="margin-top:16px;"><div style="font-size:0.75rem;font-weight:600;color:var(--muted);margin-bottom:6px;">EXPERIENCE</div>'+exp+'</div>':'')+
      '<div style="margin-top:20px;display:flex;gap:8px;">'+
        '<button class="btn-sm btn-dark" onclick="draftOutreachFor(\''+data.name+'\',\''+(data.title||'')+(data.company?' at '+data.company:'')+'\');closeProfileModal()">âœ¦ Draft outreach</button>'+
        (data.website?'<a href="'+data.website+'" target="_blank" class="btn-sm btn-ghost" style="text-decoration:none;">Website â†—</a>':'')+
      '</div>'+
    '</div>';

  document.getElementById('profile-modal').classList.add('open');
}

function closeProfileModal(){document.getElementById('profile-modal').classList.remove('open');}

// â”€â”€ CHAT â”€â”€
async function loadChatHistory(){
  const{data}=await sb.from('chats').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:true}).limit(50);
  if(data&&data.length>0){
    chatHistory=data.map(r=>({role:r.role==='assistant'?'assistant':'user',content:r.content}));
    data.forEach(r=>appendMsg(r.role==='assistant'?'agent':'user',r.content,false));
    document.getElementById('suggestion-chips').style.display='none';
  }else{
    const n=(userProfile.name||currentUser.user_metadata?.full_name||'there').split(' ')[0];
    appendMsg('agent','Hi '+n+'! I\'m your Clasp Agent, powered by Claude. I can help you find leads, draft outreach, research companies, and more.\n\nWhat would you like to work on?',false);
  }
  await updateChatCount();
}

async function sendMessage(){
  const input=document.getElementById('chat-input');
  const text=input.value.trim();
  if(!text||isLoading)return;
  input.value='';autoResize(input);
  document.getElementById('suggestion-chips').style.display='none';
  appendMsg('user',text,true);
  chatHistory.push({role:'user',content:text});
  await sb.from('chats').insert({user_id:currentUser.id,role:'user',content:text});
  await callClaude();
}

async function callClaude(){
  isLoading=true;document.getElementById('send-btn').disabled=true;
  const tid=appendTyping();
  try{
    const r=await fetch('/.netlify/functions/claude',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:getSys(),messages:chatHistory})});
    const d=await r.json();removeTyping(tid);
    if(d.content?.[0]){
      const reply=d.content[0].text;
      appendMsg('agent',reply,true);
      chatHistory.push({role:'assistant',content:reply});
      await sb.from('chats').insert({user_id:currentUser.id,role:'assistant',content:reply});
      await updateChatCount();
    }else appendMsg('agent','Something went wrong. Please try again.',false);
  }catch(e){removeTyping(tid);appendMsg('agent','Connection error â€” please try again.',false);}
  isLoading=false;document.getElementById('send-btn').disabled=false;
}

async function updateChatCount(){
  const{count}=await sb.from('chats').select('*',{count:'exact',head:true}).eq('user_id',currentUser.id);
  const el=document.getElementById('stat-chats');if(el)el.textContent=Math.floor((count||0)/2);
}

async function clearChat(){
  chatHistory=[];
  await sb.from('chats').delete().eq('user_id',currentUser.id);
  document.getElementById('chat-area').innerHTML='';
  document.getElementById('suggestion-chips').style.display='flex';
  const n=(userProfile.name||'there').split(' ')[0];
  appendMsg('agent','Chat cleared! What would you like to work on, '+n+'?',false);
}

function getSys(){
  const p=userProfile;
  const expStr=(p.experience||[]).map(e=>e.title+' at '+e.company).join(', ');
  return 'You are the Clasp Agent â€” an AI-powered professional networking assistant.\n'+
    'Helping '+(p.name||'a professional')+', '+(p.title||'a professional')+' at '+(p.company||'their company')+', '+(p.location||'their city')+'.\n'+
    'Headline: '+(p.headline||'')+'\n'+
    'About: '+(p.about||'')+'\n'+
    'Skills: '+(p.skills||[]).join(', ')+'\n'+
    'Experience: '+expStr+'\n'+
    'ICP: '+(p.icp||'')+'\n'+
    'Help with: finding leads, drafting outreach, researching companies, networking strategy. Keep responses practical and human. Sign outreach from '+(p.name||'the user')+'.';
}

// â”€â”€ OUTREACH â”€â”€
async function generateOutreach(){
  const name=document.getElementById('outreach-name').value;
  const role=document.getElementById('outreach-role').value;
  const reason=document.getElementById('outreach-reason').value;
  const type=document.getElementById('outreach-type').value;
  const tone=document.getElementById('outreach-tone').value;
  if(!name||!reason){showToast('Please fill in recipient and reason');return;}
  const rd=document.getElementById('outreach-result');const td=document.getElementById('outreach-text');
  rd.style.display='block';td.textContent='Generatingâ€¦';
  const p=userProfile;
  const prompt='Write a '+type.replace('-',' ')+' from '+(p.name||'me')+' ('+(p.title||'')+' at '+(p.company||'')+') to '+name+(role?' ('+role+')':'')+'. Reason: '+reason+'. Tone: '+tone+'.\n'+(type==='linkedin-connection'?'Keep under 300 characters.':'Keep it concise and human.')+'\nJust write the message itself, no preamble.';
  try{
    const r=await fetch('/.netlify/functions/claude',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:getSys(),messages:[{role:'user',content:prompt}]})});
    const d=await r.json();td.textContent=d.content?.[0]?.text||'Something went wrong.';
  }catch(e){td.textContent='Error â€” please try again.';}
}

async function saveDraft(){
  const name=document.getElementById('outreach-name').value;
  const role=document.getElementById('outreach-role').value;
  const type=document.getElementById('outreach-type').value;
  const content=document.getElementById('outreach-text').textContent;
  if(!content||content==='Generatingâ€¦'){showToast('Generate a message first');return;}
  const{error}=await sb.from('drafts').insert({user_id:currentUser.id,recipient_name:name,recipient_role:role,message_type:type,content});
  if(error){showToast('Error saving draft');return;}
  showToast('Draft saved!');await loadDraftsCount();
}

async function loadDraftsCount(){
  const{count}=await sb.from('drafts').select('*',{count:'exact',head:true}).eq('user_id',currentUser.id);
  const el=document.getElementById('stat-drafts');if(el)el.textContent=count||0;
}

async function loadDraftsList(){
  const{data}=await sb.from('drafts').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
  const list=document.getElementById('drafts-list');
  if(!data||data.length===0){list.innerHTML='<div style="text-align:center;padding:48px;color:var(--light);font-size:0.88rem;">No drafts saved yet.</div>';return;}
  list.innerHTML=data.map(d=>'<div class="draft-card"><div class="draft-meta"><div class="draft-to">To: '+d.recipient_name+(d.recipient_role?' Â· '+d.recipient_role:'')+' </div><span class="draft-type">'+((d.message_type||'').replace('-',' '))+'</span></div><div class="draft-content">'+d.content+'</div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;"><span class="draft-time">'+new Date(d.created_at).toLocaleDateString()+'</span><button class="btn-sm btn-ghost" onclick="navigator.clipboard.writeText(\''+d.content.replace(/'/g,"\\'")+'\').then(()=>showToast(\'Copied!\'))">Copy</button></div></div>').join('');
}

function copyOutreach(){navigator.clipboard.writeText(document.getElementById('outreach-text').textContent).then(()=>showToast('Copied!'));}
function draftOutreachFor(name,role){switchScreen('outreach',document.querySelectorAll('.nav-item')[3]);setTimeout(()=>{document.getElementById('outreach-name').value=name;document.getElementById('outreach-role').value=role;},50);}
function askClaudeToSearch(){switchScreen('agent',document.querySelectorAll('.nav-item')[0]);setTimeout(()=>{document.getElementById('chat-input').value='Find me leads matching my ICP: '+(userProfile.icp||'VP Sales at Series B+ SaaS');sendMessage();},100);}

// â”€â”€ UI â”€â”€
function appendMsg(role,text,scroll){
  const area=document.getElementById('chat-area');
  const isAgent=role==='agent'||role==='assistant';
  const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const initials=ini(userProfile.name||currentUser?.email||'U');
  const div=document.createElement('div');div.className='msg '+(isAgent?'agent':'user');
  div.innerHTML='<div class="msg-av '+(isAgent?'agent-av':'user-av')+'">'+(isAgent?'<svg viewBox="0 0 24 24" fill="white" width="12" height="12"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg>':initials)+'</div><div><div class="msg-bubble">'+fmt(text)+'</div><div class="msg-time">'+time+'</div></div>';
  area.appendChild(div);if(scroll)area.scrollTop=area.scrollHeight;
}

function fmt(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');}

function appendTyping(){
  const area=document.getElementById('chat-area');const id='t'+Date.now();const div=document.createElement('div');
  div.className='msg agent';div.id=id;
  div.innerHTML='<div class="msg-av agent-av"><svg viewBox="0 0 24 24" fill="white" width="12" height="12"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6L12 2z"/></svg></div><div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>';
  area.appendChild(div);area.scrollTop=area.scrollHeight;return id;
}
function removeTyping(id){document.getElementById(id)?.remove();}

function switchScreen(name,el){
  document.querySelectorAll('.screen,.agent-screen').forEach(s=>{s.classList.remove('active');s.removeAttribute('style');});
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const scr = document.getElementById('screen-'+name);
  if(scr) scr.classList.add('active');
  if(el)el.classList.add('active');
  const titles={agent:'Claude Agent',profile:'My Profile',people:'People',outreach:'Draft Outreach',drafts:'Saved Drafts',messages:'Messages',channels:'Team Channels'};
  document.getElementById('page-title').textContent=titles[name]||name;
  if(name==='drafts')loadDraftsList();
  if(name==='people')loadPeople();
  if(name==='messages'){loadConversations();checkUnread();}
  if(name==='channels')loadChannels();
}

function sendSuggestion(el){document.getElementById('chat-input').value=el.textContent;sendMessage();}
function handleKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function ini(name){return(name||'U').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);}
function openSpotlight(){document.getElementById('spotlight').classList.add('open');setTimeout(()=>document.getElementById('spot-input').focus(),50);}
function closeSpotlight(){document.getElementById('spotlight').classList.remove('open');}
function spotAction(text){if(!text.trim())return;closeSpotlight();document.getElementById('spot-input').value='';switchScreen('agent',document.querySelectorAll('.nav-item')[0]);setTimeout(()=>{document.getElementById('chat-input').value=text;sendMessage();},100);}
function showToast(msg){const t=document.getElementById('toast');document.getElementById('toast-msg').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
document.addEventListener('keydown',e=>{if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();openSpotlight();}if(e.key==='Escape'){closeSpotlight();closeProfileModal();}});
init();
</script>
</body>
</html>
